<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Listas de Compras Semanales</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
    h1 { text-align: center; }
    .controls, .list-selector { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; flex-wrap: wrap; }
    form { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
    form input, form select, form button, form textarea {
      flex: 1 1 100%; padding: 10px; font-size: 1em;
      border: 1px solid #ccc; border-radius: 4px;
    }
    form .half { flex: 1 1 calc(50% - 10px); }
    #itemList { list-style: none; padding: 0; }
    #itemList li {
      background: #fff; margin-bottom: 10px; padding: 10px;
      border-radius: 4px; border: 1px solid #ddd;
      display: flex; flex-direction: column;
    }
    #itemList li.checked {
      opacity: 0.6; text-decoration: line-through; background: #e0e0e0;
    }
    #itemList li.showing-hidden { opacity: 0.4; }
    .category-header {
      font-weight: bold; background: #ddd; padding: 8px; border-radius: 4px; margin-top: 15px;
    }
    .item-header { display: flex; justify-content: space-between; align-items: center; }
    .item-header h2 { margin: 0; font-size: 1.1em; }
    .item-header button {
      margin-left: 5px; padding: 5px 10px; border: none; border-radius: 4px;
      color: #fff; cursor: pointer; font-size: 0.9em;
    }
    .edit { background: #3498db; }
    .hide { background: #f39c12; }
    .show { background: #27ae60; }
    .delete { background: #e74c3c; }
    .item-details { margin-top: 5px; font-size: 0.9em; color: #555; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Listas de Compras Semanales</h1>

    <!-- Semana selector -->
    <div class="list-selector">
      <select id="weekSelect"></select>
      <input type="text" id="newWeekName" placeholder="Nombre nueva lista">
      <button type="button" id="createWeekBtn">Crear lista</button>
      <button type="button" id="deleteWeekBtn">Eliminar lista</button>
    </div>

    <!-- Mostrar ocultos & Export CSV -->
    <div class="controls">
      <label><input type="checkbox" id="toggleHidden"> Mostrar ocultos</label>
      <button type="button" id="exportCsvBtn">Exportar CSV</button>
    </div>

    <!-- Formulario de ítem -->
    <form id="itemForm">
      <input type="text" id="name" placeholder="Producto" required>
      <input type="number" id="quantity" placeholder="Cantidad" class="half" min="1" required>
      <select id="category" class="half" required>
        <option value="">Categoría</option>
        <option>Produce</option><option>Proteins</option><option>Dairy</option>
        <option>Pantry & Carbs</option><option>Frozen Foods</option><option>Beverages</option>
        <option>Snacks & Treats</option><option>Condiments & Oils</option><option>Bakery</option>
        <option>Household & Personal Care</option><option>Dog (Benji)</option>
      </select>
      <input type="text" id="aisle" placeholder="Pasillo" class="half">
      <input type="number" id="price" placeholder="Precio" class="half" step="0.01" required>
      <input type="text" id="frequency" placeholder="Frecuencia" class="half" required>
      <textarea id="notes" placeholder="Notas"></textarea>
      <button type="submit" id="submitBtn">Agregar ítem</button>
      <button type="button" id="cancelEdit" style="display:none;">Cancelar</button>
    </form>

    <!-- Lista de ítems -->
    <ul id="itemList"></ul>
  </div>

  <script>
    const LS_KEY = 'shoppingLists';
    let editingIndex = null;
    const categoryOrder = ['Produce','Proteins','Dairy','Pantry & Carbs','Frozen Foods','Beverages','Snacks & Treats','Condiments & Oils','Bakery','Household & Personal Care','Dog (Benji)'];
    const DEFAULT_ITEMS = [
      { name:'moras',quantity:1,category:'Produce',aisle:'',price:'0.00',frequency:'',notes:'',checked:false,hidden:false },
      { name:'fresas',quantity:1,category:'Produce',aisle:'',price:'0.00',frequency:'',notes:'',checked:false,hidden:false },
      { name:'guineos',quantity:10,category:'Produce',aisle:'',price:'0.00',frequency:'',notes:'',checked:false,hidden:false },
      { name:'uvas',quantity:1,category:'Produce',aisle:'',price:'0.00',frequency:'',notes:'',checked:false,hidden:false },
      { name:'limon',quantity:1,category:'Produce',aisle:'',price:'0.00',frequency:'',notes:'',checked:false,hidden:false },
      { name:'yogurt griego',quantity:3,category:'Dairy',aisle:'',price:'0.00',frequency:'',notes:'',checked:false,hidden:false },
      { name:'Pure de yuca',quantity:3,category:'Pantry & Carbs',aisle:'',price:'0.00',frequency:'',notes:'',checked:false,hidden:false },
      { name:'sweet potato fries',quantity:1,category:'Frozen Foods',aisle:'',price:'0.00',frequency:'',notes:'',checked:false,hidden:false },
      { name:'brocoli',quantity:1,category:'Produce',aisle:'',price:'0.00',frequency:'',notes:'',checked:false,hidden:false },
      { name:'lechuga',quantity:1,category:'Produce',aisle:'',price:'0.00',frequency:'',notes:'',checked:false,hidden:false },
      { name:'arroz',quantity:1,category:'Pantry & Carbs',aisle:'',price:'0.00',frequency:'',notes:'',checked:false,hidden:false }
    ];

    function getAll() {
      return JSON.parse(localStorage.getItem(LS_KEY)) || { current:'', lists:{} };
    }
    function saveAll(data) {
      localStorage.setItem(LS_KEY, JSON.stringify(data));
    }

    function init() {
      const data = getAll();
      if (!data.current) {
        data.current = 'Semana Actual';
        data.lists['Semana Actual'] = [...DEFAULT_ITEMS];
        saveAll(data);
      }
      bindControls();
      populateWeekSelect();
      renderList();
    }

    function bindControls() {
      document.getElementById('createWeekBtn').addEventListener('click', createWeek);
      document.getElementById('deleteWeekBtn').addEventListener('click', deleteWeek);
      document.getElementById('weekSelect').addEventListener('change', switchWeek);
      document.getElementById('toggleHidden').addEventListener('change', renderList);
      document.getElementById('exportCsvBtn').addEventListener('click', exportCsv);
      document.getElementById('itemForm').addEventListener('submit', onFormSubmit);
      document.getElementById('cancelEdit').addEventListener('click', cancelEdit);
    }

    function populateWeekSelect() {
      const select = document.getElementById('weekSelect');
      select.innerHTML = '';
      const data = getAll();
      for (let name in data.lists) {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        if (name === data.current) opt.selected = true;
        select.append(opt);
      }
    }

    function createWeek() {
      const name = document.getElementById('newWeekName').value.trim();
      if (!name) return alert('Escribe un nombre para la nueva lista.');
      const data = getAll();
      if (data.lists[name]) return alert('Ya existe una lista con ese nombre.');
      data.lists[name] = [...DEFAULT_ITEMS];
      data.current = name;
      saveAll(data);
      populateWeekSelect();
      renderList();
    }

    function deleteWeek() {
      const data = getAll();
      const current = data.current;
      if (Object.keys(data.lists).length === 1) {
        return alert('No puedes eliminar la única lista.');
      }
      if (!confirm(`Eliminar lista "${current}"? Esta acción no se puede deshacer.`)) return;
      delete data.lists[current];
      data.current = Object.keys(data.lists)[0];
      saveAll(data);
      populateWeekSelect();
      renderList();
    }

    function switchWeek() {
      const data = getAll();
      data.current = document.getElementById('weekSelect').value;
      saveAll(data);
      cancelEdit();
      renderList();
    }

    function getItems() {
      return getAll().lists[getAll().current] || [];
    }
    function saveItems(items) {
      const data = getAll();
      data.lists[data.current] = items;
      saveAll(data);
    }

    function onFormSubmit(e) {
      e.preventDefault();
      const items = getItems();
      const item = {
        name: document.getElementById('name').value.trim(),
        quantity: +document.getElementById('quantity').value,
        category: document.getElementById('category').value,
        aisle: document.getElementById('aisle').value.trim(),
        price: parseFloat(document.getElementById('price').value).toFixed(2),
        frequency: document.getElementById('frequency').value.trim(),
        notes: document.getElementById('notes').value.trim(),
        checked: editingIndex!==null ? items[editingIndex].checked : false,
        hidden: editingIndex!==null ? items[editingIndex].hidden : false
      };
      if (editingIndex===null) items.push(item);
      else items[editingIndex] = item;
      saveItems(items);
      cancelEdit();
      renderList();
    }

    function renderList() {
      const items = getItems();
      const showHidden = document.getElementById('toggleHidden').checked;
      const ul = document.getElementById('itemList');
      ul.innerHTML = '';
      categoryOrder.forEach(cat => {
        const group = items.filter(i => i.category === cat && (!i.hidden || showHidden));
        if (!group.length) return;
        const hdr = document.createElement('li');
        hdr.textContent = cat;
        hdr.className = 'category-header';
        ul.append(hdr);
        group.forEach((item, idx) => {
          const li = document.createElement('li');
          if (item.checked) li.classList.add('checked');
          if (item.hidden && showHidden) li.classList.add('showing-hidden');
          li.addEventListener('click', () => toggleChecked(idx));

          const dh = document.createElement('div');
          dh.className = 'item-header';
          dh.addEventListener('click', e => e.stopPropagation());

          const t = document.createElement('h2');
          t.textContent = `${item.name} (x${item.quantity})`;

          const btns = document.createElement('div');
          btns.append(
            makeBtn('Editar','edit', () => startEdit(idx)),
            makeBtn(item.hidden ? 'Mostrar' : 'Ocultar', item.hidden ? 'show' : 'hide', () => toggleHidden(idx)),
            makeBtn('Eliminar','delete', () => deleteItem(idx))
          );

          dh.append(t, btns);

          const det = document.createElement('div');
          det.className = 'item-details';
          det.innerHTML = `
            <strong>Pasillo:</strong> ${item.aisle || '-'}<br>
            <strong>Precio:</strong> $${item.price}<br>
            <strong>Frecuencia:</strong> ${item.frequency || '-'}<br>
            <strong>Notas:</strong> ${item.notes || '-'}
          `;

          li.append(dh, det);
          ul.append(li);
        });
      });
    }

    function makeBtn(text, cls, fn) {
      const b = document.createElement('button');
      b.textContent = text; b.className = cls;
      b.addEventListener('click', e => { e.stopPropagation(); fn(); });
      return b;
    }

    function toggleChecked(i) {
      const items = getItems();
      items[i].checked = !items[i].checked;
      saveItems(items); renderList();
    }
    function toggleHidden(i) {
      const items = getItems();
      items[i].hidden = !items[i].hidden;
      saveItems(items); renderList();
    }
    function startEdit(i) {
      const items = getItems(), it = items[i];
      editingIndex = i;
      document.getElementById('name').value = it.name;
      document.getElementById('quantity').value = it.quantity;
      document.getElementById('category').value = it.category;
      document.getElementById('aisle').value = it.aisle;
      document.getElementById('price').value = it.price;
      document.getElementById('frequency').value = it.frequency;
      document.getElementById('notes').value = it.notes;
      document.getElementById('submitBtn').textContent = 'Guardar cambios';
      document.getElementById('cancelEdit').style.display = 'inline-block';
    }
    function cancelEdit() {
      editingIndex = null;
      document.getElementById('itemForm').reset();
      document.getElementById('submitBtn').textContent = 'Agregar ítem';
      document.getElementById('cancelEdit').style.display = 'none';
    }
    function deleteItem(i) {
      const items = getItems();
      items.splice(i, 1);
      saveItems(items);
      renderList();
    }

    function exportCsv() {
      const items = getItems();
      const hdr = ['Nombre','Cantidad','Categoría','Pasillo','Precio','Frecuencia','Notas','Marcado','Oculto'];
      let csv = hdr.join(',') + '\n';
      items.forEach(i => {
        csv += [
          i.name, i.quantity, i.category, i.aisle,
          i.price, i.frequency, i.notes, i.checked, i.hidden
        ].map(f => `"${f}"`).join(',') + '\n';
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `lista_${getAll().current}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
