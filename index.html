<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Listas de Compras Semanales</title>
  <style>
    body { font-family: sans-serif; margin:0; padding:0; background:#f5f5f5; }
    .container { max-width:600px; margin:0 auto; padding:20px; }
    h1 { text-align:center; }

    /* Controls */
    .list-selector select,
    .list-selector input,
    .list-selector button { font-size:1.2em; }
    .list-selector, .controls {
      display:flex; gap:10px; flex-wrap:wrap;
      margin-bottom:10px; align-items:center;
    }
    .controls label { cursor:pointer; }

    /* Add form */
    #addItemSection summary {
      background:#3498db; color:#fff; padding:8px 12px;
      border-radius:4px; cursor:pointer; user-select:none;
      margin-bottom:10px; font-size:1.1em;
    }
    #addItemSection summary:hover { background:#2980b9; }
    form, .inline-form {
      display:flex; flex-wrap:wrap; gap:10px;
      background:#fff; padding:15px; border-radius:4px; border:1px solid #ddd;
    }
    form input, form select, form textarea, form button,
    .inline-form input, .inline-form select, .inline-form textarea, .inline-form button {
      flex:1 1 100%; padding:10px; font-size:1em;
      border:1px solid #ccc; border-radius:4px;
    }
    form .half, .inline-form .half { flex:1 1 calc(50% - 10px); }
    form button, form label, .inline-form button { cursor:pointer; }

    /* Main list */
    #itemList details.category-group { margin-bottom:15px; }
    #itemList summary.category-header {
      font-weight:bold; background:#ddd; padding:8px;
      border-radius:4px; cursor:pointer; user-select:none;
      list-style:none; font-size:1.05em;
    }
    #itemList ul { list-style:none; margin:0; padding:0; }
    #itemList ul li {
      background:#fff; margin:8px 0; padding:10px;
      border-radius:4px; border:1px solid #ddd;
      display:flex; flex-direction:column; font-size:1em;
    }
    #itemList ul li.checked {
      opacity:0.6; text-decoration:line-through; background:#e0e0e0;
    }
    #itemList ul li.showing-hidden { opacity:0.4; }
    .item-header { display:flex; align-items:center; margin-bottom:5px; }
    .item-header input.item-checkbox {
      margin-right:10px; transform:scale(1.3); cursor:pointer;
    }
    .item-header h2 {
      margin:0; font-size:1.1em; flex:1; cursor:pointer;
    }
    .item-header button {
      margin-left:5px; padding:5px 10px; border:none;
      border-radius:4px; color:#fff; cursor:pointer; font-size:0.9em;
    }
    .edit   { background:#3498db; }
    .hide   { background:#f39c12; }
    .show   { background:#27ae60; }
    .delete { background:#e74c3c; }
    .item-details { font-size:0.9em; color:#555; }

    /* Filter list */
    #filterList {
      margin-top:30px; background:#fafafa; padding:15px;
      border-radius:4px; border:1px solid #ccc;
    }
    #filterList h2 { margin-top:0; font-size:1.2em; text-align:center; }
    #filterList h3 { margin:15px 0 5px; font-size:1.1em; }
    #filterList ul { list-style:none; padding-left:0; }
    #filterList ul li { padding:4px 0; font-size:1em; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Listas de Compras Semanales</h1>

    <!-- Semana selector -->
    <div class="list-selector">
      <select id="weekSelect"></select>
      <input type="text" id="newWeekName" placeholder="Nombre nueva lista">
      <button id="createWeekBtn">Crear lista</button>
      <button id="deleteWeekBtn">Eliminar lista</button>
    </div>

    <!-- Mostrar ocultos & Export CSV -->
    <div class="controls">
      <label><input type="checkbox" id="toggleHidden"> Mostrar ocultos</label>
      <button id="exportCsvBtn">Exportar CSV</button>
    </div>

    <!-- Collapsible add/edit form -->
    <details id="addItemSection" open>
      <summary>Agregar ítem</summary>
      <form id="itemForm">
        <input type="text" id="name" placeholder="Producto" required>
        <input type="number" id="quantity" placeholder="Cantidad" class="half" min="1" required>
        <select id="category" class="half" required>
          <option value="">Categoría</option>
          <option>Produce</option>
          <option>Proteins</option>
          <option>Dairy</option>
          <option>Pantry & Carbs</option>
          <option>Frozen Foods</option>
          <option>Beverages</option>
          <option>Snacks & Treats</option>
          <option>Condiments & Oils</option>
          <option>Bakery</option>
          <option>Household & Personal Care</option>
          <option>Dog (Benji)</option>
        </select>
        <input type="text" id="aisle" placeholder="Pasillo" class="half">
        <input type="number" id="price" placeholder="Precio" class="half" step="0.01" required>
        <input type="text" id="frequency" placeholder="Frecuencia" class="half" required>
        <textarea id="notes" placeholder="Notas"></textarea>

        <!-- New: marcar como default -->
        <label style="flex:1 1 100%; margin-top:-5px;">
          <input type="checkbox" id="makeDefault"> Predeterminado
        </label>

        <button type="submit" id="submitBtn">Agregar</button>
        <button type="button" id="cancelAdd" style="display:none;">Cancelar</button>
      </form>
    </details>

    <!-- Rendered main list -->
    <div id="itemList"></div>

    <!-- New filtered list at bottom -->
    <div id="filterList"></div>
  </div>

  <script>
    const LS_KEY = 'shoppingLists';
    let editingIndex = null;

    const categoryOrder = [
      'Produce','Proteins','Dairy','Pantry & Carbs','Frozen Foods',
      'Beverages','Snacks & Treats','Condiments & Oils','Bakery',
      'Household & Personal Care','Dog (Benji)'
    ];

    const DEFAULT_ITEMS = [
      { name:'moras', quantity:1, category:'Produce', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'fresas', quantity:1, category:'Produce', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'guineos', quantity:10, category:'Produce', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'uvas', quantity:1, category:'Produce', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'limon', quantity:1, category:'Produce', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'yogurt griego', quantity:3, category:'Dairy', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'Pure de yuca', quantity:3, category:'Pantry & Carbs', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'sweet potato fries', quantity:1, category:'Frozen Foods', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'brocoli', quantity:1, category:'Produce', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'lechuga', quantity:1, category:'Produce', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'arroz', quantity:1, category:'Pantry & Carbs', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'avena', quantity:1, category:'Pantry & Carbs', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'granola', quantity:2, category:'Pantry & Carbs', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'maiz', quantity:2, category:'Produce', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'mantequilla', quantity:2, category:'Dairy', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'habichuela', quantity:1, category:'Proteins', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'helado', quantity:1, category:'Frozen Foods', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'zumo limon', quantity:1, category:'Beverages', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'fresas congeladas', quantity:1, category:'Frozen Foods', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'jugo', quantity:1, category:'Beverages', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'leche', quantity:3, category:'Dairy', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'popcorn', quantity:1, category:'Snacks & Treats', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'spray aceite', quantity:1, category:'Condiments & Oils', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'queso cheddar', quantity:1, category:'Dairy', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'mozzarella', quantity:1, category:'Dairy', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'huevos', quantity:1, category:'Proteins', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'toallitas humedas', quantity:2, category:'Household & Personal Care', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'prossicuto', quantity:1, category:'Proteins', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'longas de pechuga de pollo', quantity:1, category:'Proteins', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'pechugas de pollo', quantity:2, category:'Proteins', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'carne de res', quantity:5, category:'Proteins', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'pescado', quantity:1, category:'Proteins', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'carne molida', quantity:2, category:'Proteins', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'tocineta', quantity:1, category:'Proteins', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'cocacola sin azucar', quantity:1, category:'Beverages', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'crema de leche', quantity:1, category:'Dairy', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'cereal', quantity:2, category:'Pantry & Carbs', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'pasta y salsa', quantity:1, category:'Pantry & Carbs', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'pancake', quantity:1, category:'Bakery', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'tuna', quantity:3, category:'Proteins', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'aguacate', quantity:2, category:'Produce', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'honey', quantity:1, category:'Condiments & Oils', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'coffee', quantity:1, category:'Beverages', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'crema batida', quantity:1, category:'Dairy', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'chocolate chips', quantity:1, category:'Snacks & Treats', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'beef broth', quantity:1, category:'Pantry & Carbs', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'friendly benji treats', quantity:1, category:'Dog (Benji)', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'comida humeda', quantity:1, category:'Dog (Benji)', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false },
      { name:'comida solida', quantity:1, category:'Dog (Benji)', aisle:'', price:'0.00', frequency:'', notes:'', checked:false, hidden:false }
    ];

    function getAll() {
      const raw = localStorage.getItem(LS_KEY);
      const data = raw
        ? JSON.parse(raw)
        : { current:'', lists:{}, defaultItems:JSON.parse(JSON.stringify(DEFAULT_ITEMS)) };
      if (!data.defaultItems) data.defaultItems = JSON.parse(JSON.stringify(DEFAULT_ITEMS));
      return data;
    }

    function saveAll(d){ localStorage.setItem(LS_KEY, JSON.stringify(d)); }

    function init(){
      const d = getAll();
      if(!d.current){
        d.current = 'Semana Actual';
        d.lists['Semana Actual'] = JSON.parse(JSON.stringify(d.defaultItems));
        saveAll(d);
      }
      bind();
      populateWeeks();
      render();
    }

    function bind(){
      $('#createWeekBtn').onclick = createWeek;
      $('#deleteWeekBtn').onclick = deleteWeek;
      $('#weekSelect').onchange = switchWeek;
      $('#toggleHidden').onchange = render;
      $('#exportCsvBtn').onclick = exportCsv;
      $('#itemForm').onsubmit = onAdd;
      $('#cancelAdd').onclick = cancelAdd;
    }

    function populateWeeks(){
      const sel = $('#weekSelect');
      sel.innerHTML='';
      Object.keys(getAll().lists).forEach(w=>{
        const o=new Option(w,w);
        if(w===getAll().current) o.selected=true;
        sel.append(o);
      });
    }

    function createWeek(){
      const name = $('#newWeekName').value.trim();
      if(!name) return alert('Escribe un nombre para la nueva lista.');
      const d = getAll();
      if(d.lists[name]) return alert('Ya existe una lista con ese nombre.');
      d.lists[name] = JSON.parse(JSON.stringify(d.defaultItems));
      d.current = name;
      saveAll(d);
      populateWeeks();
      render();
    }

    function deleteWeek(){
      const d = getAll();
      if(Object.keys(d.lists).length===1) return alert('No puedes eliminar la única lista.');
      if(!confirm(`Eliminar lista "${d.current}"?`)) return;
      delete d.lists[d.current];
      d.current = Object.keys(d.lists)[0];
      saveAll(d);
      populateWeeks();
      render();
    }

    function switchWeek(){
      const d = getAll();
      d.current = $('#weekSelect').value;
      saveAll(d);
      editingIndex = null;
      render();
    }

    function getItems(){ return getAll().lists[getAll().current] || []; }
    function saveItems(it){ const d = getAll(); d.lists[d.current]=it; saveAll(d); }

    function onAdd(e){
      e.preventDefault();
      const d = getAll(), items = d.lists[d.current];
      const it = {
        name:$('#name').value.trim(),
        quantity:+$('#quantity').value,
        category:$('#category').value,
        aisle:$('#aisle').value.trim(),
        price:parseFloat($('#price').value).toFixed(2),
        frequency:$('#frequency').value.trim(),
        notes:$('#notes').value.trim(),
        checked:false, hidden:false
      };
      items.push(it);
      if($('#makeDefault').checked) d.defaultItems.push(it);
      saveAll(d);
      $('#itemForm').reset();
      render();
    }

    function render(){
      const items = getItems(), showHidden = $('#toggleHidden').checked;
      const listContainer = $('#itemList');
      listContainer.innerHTML='';

      categoryOrder.forEach(cat=>{
        const group = items.map((it,i)=>({it,i}))
          .filter(({it})=>it.category===cat && (!it.hidden||showHidden));
        if(!group.length) return;

        const details = document.createElement('details');
        details.className='category-group'; details.open=true;
        const summary = document.createElement('summary');
        summary.className='category-header'; summary.textContent=cat;
        details.append(summary);

        const ul = document.createElement('ul');
        group.forEach(({it:item, i:idx})=>{
          if(editingIndex===idx){
            ul.append(makeInlineForm(item,idx));
          } else {
            ul.append(makeListItem(item,idx));
          }
        });
        details.append(ul);
        listContainer.append(details);
      });

      renderFilter();
    }

    function makeListItem(item,idx){
      const li=document.createElement('li');
      if(item.checked) li.classList.add('checked');
      if(item.hidden)  li.classList.add('showing-hidden');

      const hdr=document.createElement('div'); hdr.className='item-header';
      const chk=document.createElement('input');
      chk.type='checkbox'; chk.className='item-checkbox'; chk.checked=item.checked;
      chk.onclick=e=>{e.stopPropagation(); toggleChecked(idx);};

      const title=document.createElement('h2');
      title.textContent=`${item.name} (x${item.quantity})`;
      title.onclick=()=>toggleChecked(idx);

      const btns=document.createElement('div');
      btns.append(
        makeBtn('Editar','edit',()=>startInline(idx)),
        makeBtn(item.hidden?'Mostrar':'Ocultar',item.hidden?'show':'hide',()=>toggleHidden(idx)),
        makeBtn('Eliminar','delete',()=>deleteItem(idx))
      );

      hdr.append(chk,title,btns);

      const det=document.createElement('div'); det.className='item-details';
      det.innerHTML=`
        <strong>Pasillo:</strong> ${item.aisle||'-'}<br>
        <strong>Precio:</strong> $${item.price}<br>
        <strong>Frecuencia:</strong> ${item.frequency||'-'}<br>
        <strong>Notas:</strong> ${item.notes||'-'}
      `;

      li.append(hdr,det);
      return li;
    }

    function makeInlineForm(item,idx){
      const form=document.createElement('form'); form.className='inline-form';
      const fields = [];

      // name
      const nameInput = document.createElement('input');
      nameInput.type='text'; nameInput.value=item.name; nameInput.required=true;
      fields.push(nameInput);

      // quantity
      const qtyInput = document.createElement('input');
      qtyInput.type='number'; qtyInput.value=item.quantity; qtyInput.min=1;
      qtyInput.required=true; qtyInput.className='half';
      fields.push(qtyInput);

      // category
      const catSelect = document.createElement('select');
      catSelect.className='half'; catSelect.required=true;
      categoryOrder.forEach(c=>{
        const o=new Option(c,c);
        if(c===item.category) o.selected=true;
        catSelect.append(o);
      });
      fields.push(catSelect);

      // aisle
      const aisleInput = document.createElement('input');
      aisleInput.type='text'; aisleInput.value=item.aisle; aisleInput.placeholder='Pasillo';
      aisleInput.className='half';
      fields.push(aisleInput);

      // price
      const priceInput = document.createElement('input');
      priceInput.type='number'; priceInput.value=item.price;
      priceInput.step='0.01'; priceInput.required=true; priceInput.className='half';
      fields.push(priceInput);

      // frequency
      const freqInput = document.createElement('input');
      freqInput.type='text'; freqInput.value=item.frequency;
      freqInput.className='half'; freqInput.required=true;
      fields.push(freqInput);

      // notes
      const notesInput = document.createElement('textarea');
      notesInput.value=item.notes;
      fields.push(notesInput);

      // append fields
      fields.forEach(f=>form.append(f));

      // buttons
      const saveBtn=document.createElement('button');
      saveBtn.textContent='Guardar'; saveBtn.type='submit';
      const cancelBtn=document.createElement('button');
      cancelBtn.textContent='Cancelar'; cancelBtn.type='button';
      form.append(saveBtn,cancelBtn);

      form.onsubmit=e=>{
        e.preventDefault();
        const updated = {
          name: nameInput.value.trim(),
          quantity: +qtyInput.value,
          category: catSelect.value,
          aisle: aisleInput.value.trim(),
          price: parseFloat(priceInput.value).toFixed(2),
          frequency: freqInput.value.trim(),
          notes: notesInput.value.trim(),
          checked: item.checked,
          hidden: item.hidden
        };
        const items = getItems();
        items[idx] = updated;
        saveItems(items);
        editingIndex = null;
        render();
      };
      cancelBtn.onclick=e=>{
        e.preventDefault();
        editingIndex = null;
        render();
      };

      return form;
    }

    function startInline(i){
      editingIndex = i;
      render();
    }
    function deleteItem(i){
      const items = getItems();
      items.splice(i,1);
      saveItems(items);
      render();
    }
    function toggleChecked(i){
      const items = getItems();
      items[i].checked = !items[i].checked;
      saveItems(items);
      render();
    }
    function toggleHidden(i){
      const items = getItems();
      items[i].hidden = !items[i].hidden;
      saveItems(items);
      render();
    }
    function cancelAdd(){
      $('#itemForm').reset();
      $('#cancelAdd').style.display='none';
    }

    function renderFilter(){
      const items = getItems();
      const withA = items.filter(i=>i.aisle);
      const withoutA = items.filter(i=>!i.aisle);
      const byA = {}, byC = {};
      withA.forEach(i=>(byA[i.aisle]=byA[i.aisle]||[]).push(i));
      withoutA.forEach(i=>(byC[i.category]=byC[i.category]||[]).push(i));

      const ctn = $('#filterList');
      ctn.innerHTML='<h2>Filtro: Pasillo y Categoría</h2>';

      Object.keys(byA).sort((a,b)=>{
        const na=parseFloat(a), nb=parseFloat(b);
        return (!isNaN(na)&&!isNaN(nb))? na-nb : a.localeCompare(b);
      }).forEach(a=>{
        const h3 = document.createElement('h3');
        h3.textContent = `Pasillo ${a}`;
        ctn.append(h3);
        const ul = document.createElement('ul');
        byA[a].forEach(it=>{
          const li = document.createElement('li');
          li.textContent = `${it.name} (x${it.quantity})`;
          ul.append(li);
        });
        ctn.append(ul);
      });

      categoryOrder.forEach(cat=>{
        if(!byC[cat]) return;
        const h3 = document.createElement('h3');
        h3.textContent = cat;
        ctn.append(h3);
        const ul = document.createElement('ul');
        byC[cat].forEach(it=>{
          const li = document.createElement('li');
          li.textContent = `${it.name} (x${it.quantity})`;
          ul.append(li);
        });
        ctn.append(ul);
      });
    }

    function exportCsv(){
      const items = getItems();
      const hdr = ['Nombre','Cantidad','Categoría','Pasillo','Precio','Frecuencia','Notas','Marcado','Oculto'];
      let csv = hdr.join(',')+'\n';
      items.forEach(i=>{
        csv += [
          i.name,i.quantity,i.category,i.aisle,
          i.price,i.frequency,i.notes,i.checked,i.hidden
        ].map(f=>`"${f}"`).join(',')+'\n';
      });
      const blob = new Blob([csv],{type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `lista_${getAll().current}.csv`;
      a.click(); URL.revokeObjectURL(url);
    }

    function createSelector(q){ return document.querySelector(q); }
    const $ = createSelector;

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
